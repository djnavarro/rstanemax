---
title: "Simple Emax model fit with Stan"
author: "Kenta Yoshida"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r warning=FALSE}
library(rstanemax)
library(dplyr)
library(ggplot2)
```

This vignette provide an overview of the workflow of Emax model analysis using this package.


# Typical workflow

## Model run with `stan_emax` function

`stan_emax` is the main function of this package to perfrom Emax model analysis on the data.
This function requires minimum two input arguments - `formula` and `data`.
In the `formula` argument, you will specify which columns of `data` will be used as exposure and response data, in a format similar to `stats::lm()` function, e.g. `response ~ exposure`.

```{r, results="hide"}
data(exposure.response.sample)

fit.emax <- stan_emax(response ~ exposure, data = exposure.response.sample)
```

```{r}
fit.emax
```

`plot` function shows the estimated Emax model curve with 95% credible intervals of parameters.

```{r, fig.show='hold'}
plot(fit.emax)
```

Raw output from `rstan` is stored in the output variable, and you can access it with `$stanfit`.

```{r}
class(fit.emax$stanfit)
```

## Prediction of response with new exposure data

`posterior_predict` function allows users to predict the response using new exposure data.
If `newdata` is not provided, the function returns the prediction on the exposures in original data.
The default output is a matrix of posterior predictions, but you can also specify "dataframe" or "tibble" that contain posterior predictions in a long format.
see `help(rstanemax::posterior_predict)` for the description of two predictions, `respHat` and `response`.

```{r}
response.pred <- posterior_predict(fit.emax, newdata = c(0, 100, 1000), returnType = "tibble")

response.pred %>% select(mcmcid, exposure, respHat, response)
```

You can also get quantiles of predictions with `posterior_predict_quantile` function.
Currently this function only export 95% credible intervals of mean response and 95% prediction intervals of individual responses.

```{r}
resp.pred.quantile <- posterior_predict_quantile(fit.emax, newdata = seq(0, 1000, by = 250))
resp.pred.quantile
```

This is particularly useful when you want to plot the estimated Emax curve.


```{r}
ggplot(resp.pred.quantile, aes(exposure, respHat500)) +
  geom_line() + 
  geom_ribbon(aes(ymin=respHat025, ymax=respHat975), alpha = .5) +
  geom_ribbon(aes(ymin=response025, ymax=response975), alpha = .2) +
  labs(y = "response")
```



# Fix parameter values of E0 and/or gamma (Hill coefficient) 




# Specify priors on parameters

Currently the package does not allow users to specify priors on parameters.
The plan is to specify these by a named list.




Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
